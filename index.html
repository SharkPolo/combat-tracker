<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D&D Combat Tracker</title>
    
    <!-- Configura√ß√µes PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/SharkPolo/combat-tracker/refs/heads/main/image.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overscroll-behavior-y: contain;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
        }

        .combat-list {
            flex: 1;
            overflow-y: auto;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }

        .combat-card {
            transition: all 0.2s ease;
        }

        .card-selected {
            border-color: #3b82f6 !important;
            background-color: rgba(30, 41, 59, 0.8) !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .active-turn {
            border-left: 4px solid #f59e0b !important;
        }

        .btn-numpad {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.25rem;
            height: 54px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-numpad:active {
            background: #334155;
            transform: scale(0.95);
        }

        .btn-control {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        #modalOverlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <!-- Cabe√ßalho -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center shrink-0">
        <h1 class="text-xl font-bold text-slate-200">Combat Tracker <span class="text-xs text-slate-500 font-normal">v3.5</span></h1>
        <div class="flex gap-2">
            <button onclick="sortInitiative()" class="text-xs bg-slate-800 px-3 py-1 rounded-full border border-slate-700 font-bold text-slate-400">ORDENAR</button>
        </div>
    </header>

    <!-- Lista de Cards -->
    <main class="combat-list p-4 space-y-3" id="combatList">
        <!-- Gerado via JS -->
    </main>

    <!-- Console Inferior -->
    <footer class="bg-slate-900 border-t border-slate-800 py-4 px-0 shrink-0">
        <div class="max-w-xl mx-auto flex gap-4">
            
            <!-- Coluna 1: Controles -->
            <div class="flex flex-col gap-2 w-24 shrink-0 justify-between py-1">
                <div class="text-center">
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest leading-none">Rodada</p>
                    <p id="roundCounter" class="text-xl font-bold text-slate-200">1</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openModal('player')" class="btn-control hover:bg-blue-900/40 border-blue-900/50">üßô‚Äç‚ôÇÔ∏è</button>
                    <button onclick="openModal('monster')" class="btn-control hover:bg-slate-700">üßå</button>
                    <button onclick="endCombat()" onmousedown="startEndCombatPress(event)" onmouseup="cancelEndCombatPress(event)" onmouseleave="cancelEndCombatPress(event)" ontouchstart="startEndCombatPress(event)" ontouchend="cancelEndCombatPress(event)" class="btn-control hover:bg-red-900/40 border-red-900/50">‚ùå</button>
                    <button onclick="nextTurn()" class="btn-control hover:bg-amber-900/40 border-amber-900/50">‚è©</button>
                    <button onclick="toggleSpiralStatus()" class="btn-control hover:bg-slate-700">üåÄ</button>
                    <button onclick="toggleBrainStatus()" class="btn-control hover:bg-slate-700">üß†</button>
                </div>
            </div>

            <!-- Coluna 2: Teclado Num√©rico -->
            <div class="flex-1">
                <div class="flex justify-between items-center mb-2 px-1">
                    <div class="text-lg text-slate-500 font-bold overflow-hidden whitespace-nowrap truncate mr-2">
                        Alvo: <span id="targetName" class="text-blue-400">Nenhum</span>
                    </div>
                    <div class="text-lg font-mono font-bold text-slate-100 shrink-0" id="numpadDisplay">0</div>
                </div>

                <div class="numpad-grid">
                    <button class="btn-numpad" onclick="addDigit('7')">7</button>
                    <button class="btn-numpad" onclick="addDigit('8')">8</button>
                    <button class="btn-numpad" onclick="addDigit('9')">9</button>
                    <button class="btn-numpad" onclick="addDigit('4')">4</button>
                    <button class="btn-numpad" onclick="addDigit('5')">5</button>
                    <button class="btn-numpad" onclick="addDigit('6')">6</button>
                    <button class="btn-numpad" onclick="addDigit('1')">1</button>
                    <button class="btn-numpad" onclick="addDigit('2')">2</button>
                    <button class="btn-numpad" onclick="addDigit('3')">3</button>
                    <button class="btn-numpad text-red-400" onclick="applyNumpad('damage')">DANO</button>
                    <button class="btn-numpad" onclick="addDigit('0')">0</button>
                    <button class="btn-numpad text-green-400" onclick="applyNumpad('heal')">CURA</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal Adicionar -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Adicionar</h2>
            <div class="space-y-4">
                <input type="text" id="inName" placeholder="Nome" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-lg outline-none focus:border-blue-500">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="inIni" placeholder="Iniciativa" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-lg outline-none">
                    <input type="number" id="inHP" placeholder="HP M√°ximo" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-lg outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="inCA" placeholder="CA" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-lg outline-none">
                    <input type="text" id="inAtk" placeholder="Ataque/Dano" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-lg outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 bg-slate-700 rounded-xl font-bold">Cancelar</button>
                <button onclick="addCombatant()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">Adicionar</button>
            </div>
        </div>
    </div>

    <script>
        let combatants = [];
        let selectedId = null;
        let activeTurnIndex = 0;
        let round = 1;
        let numpadValue = "0";
        let currentModalType = 'player';
        let monsterCounter = 1;
        let lastMonsterData = { hp: "", ca: "", atk: "" };
        let endCombatPressTimer;
        let didEndCombatLongPress = false;

        window.onload = () => {
            const savedPlayers = localStorage.getItem('dnd_players');
            if (savedPlayers) {
                combatants = JSON.parse(savedPlayers);
                renderList(true);
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
            }
        };

        function renderList(shouldResort = false) {
            const container = document.getElementById('combatList');
            container.innerHTML = '';
            
            combatants.forEach((c, index) => {
                const card = document.createElement('div');
                card.id = `card-${c.id}`;
                const hpPercent = (c.hpCurrent / c.hpMax) * 100;
                const hpColor = hpPercent > 50 ? 'text-green-400' : hpPercent > 20 ? 'text-amber-400' : 'text-red-500';

                card.className = `combat-card bg-slate-800/40 border border-slate-700 p-0 px-2 rounded-2xl flex items-center justify-between cursor-pointer transition-all relative overflow-hidden
                    ${selectedId === c.id ? 'card-selected' : ''} 
                    ${activeTurnIndex === index ? 'active-turn' : ''}`;
                
                card.onclick = () => selectCombatant(c.id, c.name);

                let statusHtml = '';
                if (c.statusSpiral) statusHtml += 'üåÄ';
                if (c.statusBrain) statusHtml += 'üß†';

                card.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="${activeTurnIndex === index ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300'} font-bold w-10 h-10 flex items-center justify-center rounded-full text-lg shrink-0 my-1">
                            ${c.initiative}
                        </div>
                        <div class="py-1">
                            <h3 class="font-bold text-lg leading-none ${c.type === 'monster' ? 'text-red-400' : ''}">${c.name}</h3>
                            <p class="text-slate-300 text-lg font-semibold tracking-tight leading-none mt-1">CA: ${c.ca} | ${c.atkInfo}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-2xl flex gap-1">${statusHtml}</div>
                        <div class="text-center py-1">
                            <div class="text-2xl font-bold leading-none ${hpColor}">${c.hpCurrent}/${c.hpMax}</div>
                            <div class="text-[10px] uppercase text-slate-500 font-bold tracking-wider leading-none mt-1">HP</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('roundCounter').innerText = round;
        }

        function selectCombatant(id, name) {
            selectedId = id;
            document.getElementById('targetName').innerText = name;
            renderList(false);
        }

        function addDigit(digit) {
            if (numpadValue === "0") numpadValue = digit;
            else numpadValue += digit;
            document.getElementById('numpadDisplay').innerText = numpadValue;
        }

        function applyNumpad(type) {
            if (!selectedId) return;
            const val = parseInt(numpadValue);
            const index = combatants.findIndex(c => c.id === selectedId);
            if (index === -1) return;

            if (type === 'damage') combatants[index].hpCurrent = Math.max(0, combatants[index].hpCurrent - val);
            if (type === 'heal') combatants[index].hpCurrent = Math.min(combatants[index].hpMax, combatants[index].hpCurrent + val);

            numpadValue = "0";
            document.getElementById('numpadDisplay').innerText = "0";
            renderList(false);
        }

        function nextTurn() {
            activeTurnIndex++;
            if (activeTurnIndex >= combatants.length) {
                activeTurnIndex = 0;
                round++;
            }
            if (combatants.length > 0) {
                selectCombatant(combatants[activeTurnIndex].id, combatants[activeTurnIndex].name);
                document.getElementById(`card-${combatants[activeTurnIndex].id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            renderList(false);
        }

        function openModal(type) {
            currentModalType = type;
            document.getElementById('modalTitle').innerText = type === 'player' ? 'Novo Jogador' : 'Novo Monstro';
            document.getElementById('inName').value = type === 'player' ? '' : `Monstro ${monsterCounter}`;
            document.getElementById('inHP').value = type === 'player' ? '' : lastMonsterData.hp;
            document.getElementById('inCA').value = type === 'player' ? '' : lastMonsterData.ca;
            document.getElementById('inAtk').value = type === 'player' ? '' : lastMonsterData.atk;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('inName').focus();
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function addCombatant() {
            const name = document.getElementById('inName').value;
            const hp = parseInt(document.getElementById('inHP').value) || 10;
            const ini = parseInt(document.getElementById('inIni').value) || 0;
            const ca = document.getElementById('inCA').value || "10";
            const atk = document.getElementById('inAtk').value || "---";

            const newItem = {
                id: Date.now(),
                name,
                type: currentModalType,
                hpMax: hp,
                hpCurrent: hp,
                initiative: ini,
                ca: ca,
                atkInfo: atk,
                statusSpiral: false,
                statusBrain: false
            };

            if (currentModalType === 'monster') {
                monsterCounter++;
                lastMonsterData = { hp, ca, atk };
            }

            combatants.push(newItem);
            if (currentModalType === 'player') savePlayersToStorage();
            closeModal();
            renderList(true);
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            activeTurnIndex = 0;
            renderList(false);
        }

        function toggleSpiralStatus() {
            if (!selectedId) return;
            const idx = combatants.findIndex(c => c.id === selectedId);
            combatants[idx].statusSpiral = !combatants[idx].statusSpiral;
            renderList(false);
        }

        function toggleBrainStatus() {
            if (!selectedId) return;
            const idx = combatants.findIndex(c => c.id === selectedId);
            combatants[idx].statusBrain = !combatants[idx].statusBrain;
            renderList(false);
        }

        function startEndCombatPress(e) {
            didEndCombatLongPress = false;
            endCombatPressTimer = setTimeout(() => {
                didEndCombatLongPress = true;
                hardResetCombat();
            }, 3000);
        }

        function cancelEndCombatPress() {
            clearTimeout(endCombatPressTimer);
        }

        function hardResetCombat() {
            combatants = [];
            localStorage.removeItem('dnd_players');
            round = 1;
            activeTurnIndex = 0;
            monsterCounter = 1;
            renderList(true);
        }

        function endCombat() {
            if (didEndCombatLongPress) return;
            combatants = combatants.filter(c => c.type === 'player');
            combatants.forEach(c => c.initiative = 0);
            round = 1;
            activeTurnIndex = 0;
            renderList(true);
        }

        function savePlayersToStorage() {
            const players = combatants.filter(c => c.type === 'player');
            localStorage.setItem('dnd_players', JSON.stringify(players));
        }
    </script>
</body>
</html>

